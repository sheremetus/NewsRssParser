<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Source List</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
          rel="stylesheet">

    <style>
        .lires {
            border: 2px solid black; /* Рамка вокруг каждого элемента списка */
            padding: 5px; /* Внутренний отступ */
            margin-bottom: 10px; /* Внешний отступ */
        }

        body {
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        .container {
            margin-top: 20px;
            padding-left: 0;
            padding-right: 0;
        }

        .row {
            margin-left: 0;
            margin-right: 0;
        }

        .form-control, .btn {
            border-radius: 0;
        }

        .btn {
            background-color: #34495e;
            color: #ecf0f1;
            width: auto;
        }

        .btn:hover {
            background-color: #2c3e50;
        }

        .source-list {
            background-color: #34495e;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #2c3e50;
        }

        .source-item:last-child {
            border-bottom: none;
        }

        .source-item span {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .search-results {
            background-color: #34495e;
            padding: 10px;
            border-radius: 5px;
        }

        .highlight {
            background-color: orange;
        }
    </style>

</head>
<body>
<div class="container-fluid">
    <div class="row no-gutters">
        <div class="col-md-2">
            <div class="source-list">
                <h4>Источники</h4>
                <ul class="list-unstyled">
                    <li th:each="source : ${sources}" class="source-item">
                        <span th:text="${source.url}"></span>
                        <form action="/delete" method="post" style="display:inline;">
                            <input type="hidden" name="id" th:value="${source.id}">
                            <button type="submit" class="btn btn-danger btn-sm">Удалить</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-md-2">
            <div class="source-list">
                <h4>Источники telegram</h4>
                <form action="/getTelegramSources" method="get" class="text-center mb-4">
                    <button type="submit" class="btn btn-primary">Запросить источники telegram</button>
                </form>

                <form action="/searchAll" method="get" class="text-center mb-4">
                    <li th:each="source : ${tgSources}" class="source-item">
                        <input type="checkbox" name="sourceIndex" th:value="${source.idx}"/>
                        <span th:text="${source.getName()}"></span>
                    </li>
                    <br>
            </div>
        </div>
        <div class="col-md-8">
<!--            <div class="form-group">-->
<!--                <input type="text" name="limit" class="form-control"-->
<!--                       placeholder="Лимит проверяемых сообщений в телеграмме" required>-->
<!--            </div>-->
            <div class="form-group">
                <input type="text" name="keyword" class="form-control"
                       placeholder="Поиск информации по ключевым словам по телеграмму и RSS" required>
            </div>

            <br>
            <label for="date_start">Выберите дату с которой начать поиск:</label>
            <input type="text" class="form-control datepicker" id="date_start" name="start_date">
            <br>
            <label for="date_end">Выберите дату, до которой вести поиск:</label>
            <input type="text" class="form-control datepicker" id="date_end" name="end_date">
            <br>
            <div class="form-group">
                <button type="submit" class="btn btn-secondary">Поиск</button>
            </div>
            <br>
            </form>
            <div id="content" class="search-results mt-4">
                <h4>Результаты поиска:</h4>
                <ul class="list-unstyled">
                    <li class="lires" th:each="res : ${resultsTg}">
                        <p th:text="${res.section}"></p>
                        <div th:each="img : ${res.image}">
                            <a href="#" onclick="openImage('${@thymeleafUtil.encodeBase64(res.image)}')">
                                <img width="400" height="300"
                                     th:src="'data:image/png;base64,' + ${@thymeleafUtil.encodeBase64(img)}"/>
                            </a>
                                            </div>
                                            <form action="/postToTelegram" method="post" style="display: inline;">
                                                <input type="hidden" name="text" th:value="${res.section}">
                                                <button type="submit" class="btn btn-primary btn-sm">Запостить в Telegram</button>
                                            </form>
                                            <div th:if="${message}" class="alert alert-success" role="alert">
                                                <span th:text="${message}"></span>
                                            </div>
                                            <div th:if="${error}" class="alert alert-danger" role="alert">
                                                <span th:text="${error}"></span>
                                            </div>
                                            <br/>
                        <div th:each="link : ${res.linkHref}">
                            <a th:href="${link}">link</a>
                        </div>
                        <br/>
                    </li>
                </ul>
                <br>
                <br>
                <h4>Результаты поиска по сайтам</h4>
                <ul class="list-unstyled">
                    <li class="lires" th:each="item : ${resultsRSS}">
                        <a th:href="${item.link.get()}">
                            <p th:text="${item.title.get()}"></p>
                        </a>
                        <p th:text="${item.getPubDate().get()}"></p>
                        <p th:text="${item.getDescription().get()}"></p>
                        <br/>
                        <br/>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
</div>
<!-- Подключение jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Подключение Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<!-- Подключение Bootstrap Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<!-- Инициализация Datepicker -->
<script>
    $(document).ready(function () {
        $('.datepicker').datepicker({
            format: 'yyyy-mm-dd'
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('.post-to-telegram').click(function() {
            var text = $(this).data('text');

            $.ajax({
                url: '/postToTelegram',
                method: 'POST',
                data: { text: text },
                success: function(response) {
                    alert('Сообщение успешно отправлено в Telegram');
                },
                error: function() {
                    alert('Ошибка при отправке сообщения в Telegram');
                }
            });
        });
    });
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    let patterns = /*[[${keywords}]]*/ [];

    const marker = (text, patterns) => {
        return patterns.reduce((result, current) => {
            let regexp = new RegExp(current, 'gi');
            return result.replace(regexp, `<span class="highlight">${current}</span>`);
        }, text);
    }

    document.querySelectorAll('.lires p').forEach((element) => {
        let text = element.innerHTML;
        element.innerHTML = marker(text, patterns);
    });
    /*]]>*/
</script>
</body>
</html>